---
title: "walking_accessibility"
author: "Greta"
date: "11/18/2021"
output: md_document
---
This notebook focuses on exploring OSM data related to cycling and walking. It is limited to West Yorkshire.

# walking + accessibility

## Brief discussion of lit review on OSM, walking + accessibility

In 2017, Barrington-Leigh and Millard-Ball estimated that over 80% of OSM road data is complete. However, the conceptualization of roads was restricted to "vehicle circulation" (Barrington-Leigh and Millard-Ball, 2017:7). Authors (2017) note that non-vehicle modes of travel, e.g., walking, are excluded (based on their highway tags, cycling seems to have been excluded as well). While the high completeness of OSM road data is welcomed -- even if completeness does not directly translate to, for example, positional accuracy -- however, it still raises a question regarding the extent to which other ways are mapped and how open data could be used to plan (open) infrastructure. This question is especially important in the context of active travel in England and the current attempts to move from motor-centric traffic to walking and cycling (see [DfT et al., 2020](https://www.gov.uk/government/news/2-billion-package-to-create-new-era-for-cycling-and-walking)).

It is important to note that OSM data has been utilized to map and plan both cycling (Ferster et al., 2020; Orozco et al., 2020) and pedestrian networks (Novack et al., 2018). Even though both cycling and walking have substantial individual and environomental, such as improved mental and physical health and reduced air pollution, benefits (Woodcock et al., 2013), it can be argued that walking is more accessible because it is free and familiar ([Ogilvie et al., 2007](https://www.bmj.com/content/bmj/334/7605/1204.full.pdf)) and less physically demanding ([Yang et al., 2010](https://www.bmj.com/content/bmj/341/bmj.c5293.full.pdf)) and, thus should be prioritized.

The potential of the OSM data in mapping and planning pedestrian routes has been explored from a typological perspective (see Cambra et al., 2019) and applied in evaluating and measuring walkability (Dunn et al., 2018), generating customized pleasant pedestrian routes (Novack et et., 2018), and even utilized to support people with disabilities in navigating their everyday life (Mobasheri et al., 2017; Boularouk et al., 2017; Cohen and Dalyot, 2021). However, Mobasheri et al. (2018) note that OSM sidewalk data is incomplete, hence limiting its routing potential for people with limited mobility. Furthermore, Boularouk et al. (2017) point out that the ability to use OSM data might reduce the cost of assistive technology for people with visual impairment because data is free. In terms of key accessible road elements, Biagi et al. (2020) identified the following:

-   sidewalk width;
-   slope;
-   kerb;
-   road signs and their height;
-   drains and other elements;
-   parking;
-   traffic lights (sound might be needed for the (partially) deaf);

Additionally, there is another difficulty posed by OSM data -- tags. Mappers are not always constrained by the values that can be assigned to tags that are essential in defining road elements (Boularouk et al. (2017) calls this practice folksonomy as in opposition to taxonomy; also see Ferster et al. (2020) on labeling issues in the context of cycling). The lack of tag homogeneity might make the application of OSM data more challenging, however it possibly helps to keep the space open for local interventions and bottom-up changes to what (and also how) the world is mapped and represented. The accessibility of OSM data is one of the benefits identified by Haklay (2010). Finally, it is important to emphasise that mapping (including digital tools such as WheelMap) helps to address but does not eliminate the material barriers (Rebernik et al., 2021).

Following the overview of OSM data in relation to walking and accessibility, in this notebook I aim to: a) map and measure the extent to which walking infrastructure is mapped in relation to the (mapped) highways; b) consider issues posed by tagging (such as nonsensical values (e.g., width = -1)) c) reflect on how pedestrian network can be conceptualized using OSM data

Other (potentially) interesting projects that focus on sidewalks + inclusivity:

-   WheelMap
-   OpenSidewalks project
-   CAP4Access

# cycling (empty)

Tags of interest for cycling:

surface maxspeed:type width maxwidth width:lanes

bicycle cycleway cycleway:both cycleway:right cycleway:left cycleway:both:lane cycleway:left:lane cycleway:right:lane cycleway:left:width cycleway:right:width oneway:bicycle cycleway:otherside\
cycleway:otherside:width cycleway:both:width cycleway:oneside cycleway:oneside:width cycleway:right:oneway cycleway:width cycleway:surface bicycle_road cyclestreet cycleway:buffer cycleway:left:separation:right bicycle:lanes:conditional bicycle:lanes:forward:conditional cycleway:lane cycleway:left:foot cycleway:left:oneway\
cycleway:left:segregated\
cycleway:left:seperation:right\
cycleway:proposed\
cycleway:right:separation:left "cycle" "cycleway:est_width"

# libraries and data

## libraries

```{r}
# load up the libraries
library(osmextract) 
library(tidyverse)
library(sf)
```

## datasets

Data is limited to West Yorkshire. `osmextract` was used to query the OSM database. For a query example see the code below, otherwise proceed to uploading the provided .Rds files.

```{r}
# QUERY EXAMPLE
# oe_match_pattern("Yorkshire")
# region_name <- "West Yorkshire"
# wy <- osmextract::oe_get(place = region_name,
#                          layer = "lines",
#                          force_download = TRUE,
#                          force_vectortranslate = TRUE) # importing West Yorkshire data

```

```{r}
# note: you might have to indicate the path to the directory - download from:
# https://github.com/udsleeds/openinfra/releases - or if you have piggyback...
# piggyback::pb_download("wy.Rds")
# piggyback::pb_download("wy_walking.Rds")
# piggyback::pb_download("wy_pct.Rds")
wy <- readRDS("wy.Rds") 
# wy_short <- readRDS("wy_short.Rds")
# wy_cycling_net <- readRDS("wy_cycling_net.Rds")
# wy_cn_short <- readRDS("wy_cn_short.Rds")
wy_pct <- readRDS("wy_pct.Rds")
leeds <- wy_pct %>% filter(lad_name == "Leeds")
wy_walking <- readRDS("wy_walking.Rds")
# wy_walk_short <- readRDS("wy_walking.Rds")
```

## additional functions

```{r}
# My very first function of which I am very proud :)
# what it does:
# 1. calculates the ratio of the (sf) column's non-NA cases (rows) to the total number of cases (rows)
# 2. converts ratio to percentages
# 3. rounds to 2 significant numbers
perc_ratio <- function(df = dataframe, x = character()){
((df %>% pull(x) %>% table() %>% sum()) / (df %>% nrow()) * 100) %>% 
    signif(digits = 2)
}
```

```{r}
# a function that returns a table of sf object's column's values sorted decreasingly
sf_col_table <- function(df = dataframe,
                         x = character()){
  df %>% pull(x) %>% table %>% sort(decreasing = TRUE)
                         }
```

# walking + accessibility

```{r}
# the code below was used to import the data.

# et_walking <- c("wheelchair",
# "kerb",
# "disabled",
# "mobility_scooter",
# "handicap",
# "foot",
# "lit", # https://wiki.openstreetmap.org/wiki/Key:lit
# "access",
# "sidewalk",
# "footway",
# "incline",
# "smoothness",
# "est_width",
# "ramp",
# "sidewalk_left",
# "sidewalk_right",
# "ramp_wheelchair",
# "footway_left",
# "footway_right",          
# "footway_surface", 
# "priority",
# "sidewalk_both_surface", 
# "path",                                   
# "pedestrian",
# "capacity_disabled",
# "sidewalk_left_width",                    
# "sidewalk_right_surface")
# 
# oe_match_pattern("Yorkshire")
# region_name <- "West Yorkshire"
# 
# wy_walking <- osmextract::oe_get(region_name,
#                                  force_vectortranslate = TRUE,
#                                  extra_tags = et_walking
#                                  )

# ============
# `wy_walking` is the data we'll use in this section. 

# wy_walking %>% str() 
# wy_walking %>% names()
# wy_walking %>% nrow()
# wy_walking %>% ncol()
```

## keys and tags

### key:foot

Legal access restriction for pedestrians. <https://wiki.openstreetmap.org/wiki/Key:foot>

```{r}
foot_perc <- perc_ratio(wy_walking, "foot") # see chunk 3 (or 'additional functions' section)
foot_perc # around 5% of all highways have the 'foot' column not NA

sf_col_table(wy_walking, "foot") # see chunk 4 (or 'additional functions' section)

wy_walking %>% select(foot) %>% plot
# where is walking not allowed?
wy_foot_no = wy_walking %>% 
  filter(foot == "no")

wy_foot_no %>% 
  mapview::mapview() # less than ~1000 so OK with interactive map
# what kind of highways is this?
wy_foot_no %>% 
  st_drop_geometry() %>% 
  group_by(highway) %>% 
  summarise(n = n(), percent = scales::percent(n / nrow(wy_foot_no))) %>% 
  arrange(desc(n))
table(wy_foot_no$highway)

st_geometry(leeds) %>% plot(reset = FALSE)
wy_walking %>% select(foot) %>% plot(add = TRUE)

```

### <tag:highway=footway>

The tag highway=footway is used for mapping minor pathways which are used mainly or exclusively by pedestrians. <https://wiki.openstreetmap.org/wiki/Tag:highway%3Dfootway>

```{r}
# highway='footway' tag is stored in highway key, so we'll have to extract the rows that are footways
wy_walking %>% pull(highway) %>% table() %>% sort(decreasing = TRUE)
wy_walking <- wy_walking %>% mutate(footway_coded = if_else(highway=="footway", TRUE, NA) %>% as.character()) # adding a new logical column' TRUE will indicate that the row is highway=footway
(wy_walking %>% pull(footway_coded) %>% table() %>% sum()) == (wy_walking %>% pull(highway)%>% str_detect("footway") %>% sum(na.rm = TRUE) ) # comparing if if_else was applied correctly; it must be TRUE

footway_coded_perc <- perc_ratio(wy_walking, "footway_coded") # see chunk 3 (or 'additional functions' section)
footway_coded_perc 

st_geometry(leeds) %>% plot(reset = FALSE)
wy_walking %>% select(footway_coded) %>% plot(add = TRUE)

```

## key:footway

Key:footway is different from <tag:highway=footway> as it allows to differentiate between highway=footway as sidewalk associated with a parallel carriageway (to constitute the street) and highway=footway that incidentally are parallel to a street.

<https://wiki.openstreetmap.org/wiki/Key:footway>

```{r}
footway_perc <- perc_ratio(wy_walking, "footway") # see chunk 3 (or 'additional functions' section)
footway_perc

sf_col_table(wy_walking, "footway") # see chunk 4 (or 'additional functions' section)

wy_walking %>% select(footway) %>% plot

st_geometry(leeds) %>% plot(reset = FALSE)
wy_walking %>% select(footway) %>% plot(add = TRUE)

```

It's interesting how much this number is lower than highway='footway'. I wonder if it's because the area has been mapped before key:footway became normalized or because it's easier to map it as part of the highway...

Not sure if `foot` and `footway` overlap? `footway` might be excessive (potential overlap with `sidewalk` as well).

```{r}
# Let's figure out many of `footway` is within `foot`.

foot_walking <- wy_walking %>% select(foot) %>% filter(!is.na(foot))  
# foot_walking %>% pull(foot) %>% table()
footway_walking <- wy_walking %>% select(footway) %>% filter(!is.na(footway))

# foot_walking %>% pull(foot) %>% table() 
# footway_walking %>% pull(footway) %>% table()

# I'll use `st_within` argument because I want to make sure that *both* ways are being mapped in the same location rather than, for example, touching each other (for that I'd use `st_touches`).

# footway_walking[foot_walking, op = st_contains] # how is this argument different from `st_within`?
footway_in_foot <- foot_walking[footway_walking, op = st_within]
foot_table <- footway_in_foot %>% # which paths in foot are within footway?
  pull(foot) %>% 
  table() # making a table with values and their counts
foot_table


# the sum of the values in the `footway_table` should be the same even if we swap variables in subsetting. Let's check.
footway_table <- footway_walking[foot_walking, op = st_within] %>% 
  pull(footway) %>% 
  table() 
(foot_table %>% sum()) == (footway_table %>% sum())
# >  TRUE
footway_table

# Let's plot the ways in Leeds area
st_geometry(leeds) %>% plot(reset = FALSE)
foot_walking %>% plot(add = TRUE,
                      col = "blue")
footway_walking %>% plot(add = TRUE,
                         col = "green",
                         lwd = 1.5)
footway_in_foot %>% plot(add = TRUE,
                         col='red',
                         lwd = 2)
title(sub = "blue -> foot, green -> footway, red -> footway in foot")

```

Initial thoughts: most of the ways that are marked as both `foot` and `footway` conglomerate in central Leeds. It makes sense because these might be shopping streets/areas. However, it makes data cleaning a bit harder: do we just create a new `sf` object where we add `foot_in_footway` to `foot`? How do we preserve the information given by `footway` if we merge? does `footway` give any useful information that is needed to be preserved?

-   I guess it's a matter of conceptualization of the (quality) walking network...

Additional note: using `footway` to indicate additional sidewalk information (e.g., left or right) has been depreciated and using `sidewalk` is preferred.

```{r}
# a question on how `st_disjoint` works, if we have time...
foot_walking %>% nrow() 
foot_walking[footway_walking, op = st_disjoint] %>% pull(foot) %>%  table() %>% sum() # why does it return *all* rows and not only the ones it should be unconnected with?

# footway_walking[foot_walking, ] %>% pull(footway) %>%  table() 
# footway_walking[foot_walking, op = st_disjoint] %>% table() %>% sum()
```

### <tag:sidewalk>

The sidewalk (or pavement) is that part of a highway set aside for the use of pedestrians and sometimes also cyclists, separated from the carriageway (or roadway). <https://wiki.openstreetmap.org/wiki/Sidewalks>

```{r}
sidewalk_perc <- perc_ratio(wy_walking, "sidewalk") # see chunk 3 (or 'additional functions' section)
sidewalk_perc

sf_col_table(wy_walking, "sidewalk") # see chunk 4 (or 'additional functions' section)

st_geometry(leeds) %>% plot(reset = FALSE)
wy_walking %>% select(sidewalk) %>% 
  filter(!is.na(sidewalk) & sidewalk != "no" & sidewalk != "none") %>%
  plot(add = TRUE,
       col = 'red')

```

```{r}
# let's check if `sidewalk` is within `footway`
sidewalk_walking <- wy_walking %>% select(sidewalk) %>% filter(!is.na(sidewalk))
footway_walking[sidewalk_walking, op = st_within] # empty;

```

It's empty. Most likely mappers use `sidewalk` tag instead of `footway=sidewalk` even though this does not seem to be discouraged by OSM. OSM does indicate, however, that 'footway=yes' should be replaced with 'sidewalk=yes'.

```{r}
# `sidewalk` does, however, contain `sidewalk` but I don't think it's a problem as they contain different information
# foot_walking[sidewalk_walking, op = st_within] %>% plot()
foot_walking[sidewalk_walking, op = st_within] %>% pull(foot) %>% table()

```

### key:wheelchair

This tag may be used to mark places or ways that are suitable to be used with a wheelchair and a person with a disability who uses another mobility device (like a walker). *It should only be used if you are sure about it*, this can either be because there's a special sign or because of personal experience/someone with a wheelchair told you. <https://wiki.openstreetmap.org/wiki/Key:wheelchair>

```{r}
wheelchair_perc <- perc_ratio(wy_walking, "wheelchair") # see chunk 3 (or 'additional functions' section)
sidewalk_perc

sf_col_table(wy_walking, "wheelchair") # see chunk 4 (or 'additional functions' section)

# (((wy_walking %>%  filter(wheelchair == "yes" | wheelchair == "designated") %>% pull(wheelchair) %>% table() %>% sum()) / wy_walking %>% nrow() ) * 100) %>% signif(2)

st_geometry(leeds) %>% plot(reset = FALSE,
                            col = "light gray")
title("Leeds",
      sub = "blue -> mapped sidewalks (0.93%)
      red -> sidewalks accessible for wheelchair users (0.084%)"
      )
wy_walking %>% select(sidewalk) %>% filter(sidewalk != "none" & sidewalk != "no") %>% plot(add = TRUE,
                                                                                           col = "blue",
                                                                                           lwd = 1.5)
wy_walking %>% select(wheelchair) %>% filter(wheelchair == "yes" | wheelchair == "designated") %>%
  plot(add = TRUE,
       col = "red",
       lwd = 1.5)
```

## key:kerb

Kerb is the edge where a road meets a sidewalk. <https://wiki.openstreetmap.org/wiki/Key:kerb>

values:

-   raised: \>3cm, wheelchair=no
-   lowered: \~3cm, wheelchair = yes
-   flush: \~0cm, wheelchair = yes

flush kerbs might hinder the navigation process for the (partially) blind, hence tactile paving key should be mapped at these locations.

```{r}
kerb_perc <- perc_ratio(wy_walking, "kerb") # see chunk 3 (or 'additional functions' section)
kerb_perc

sf_col_table(wy_walking, "kerb") # see chunk 4 (or 'additional functions' section)

wy_walking %>% select(kerb) %>% plot()

st_geometry(leeds) %>% plot(reset = FALSE)
wy_walking %>% select(kerb) %>% 
  filter(!is.na(kerb) ) %>%
  plot(add = TRUE,
       col = 'red')
```

### key:tactile_paving

Tactile paving is a system of textured ground surface indicators found on footpaths, stairs and public transportation platforms to assist pedestrians who are visually impaired. <https://wiki.openstreetmap.org/wiki/Key:tactile_paving>

```{r}
tact_perc <- perc_ratio(wy_walking, "tactile_paving") # see chunk 3 (or 'additional functions' section)
tact_perc

sf_col_table(wy_walking, "tactile_paving") # see chunk 4 (or 'additional functions' section)

wy_walking %>% select(tactile_paving) %>% plot()

st_geometry(leeds) %>% plot(reset = FALSE)
wy_walking %>% select(tactile_paving) %>% 
  filter(!is.na(tactile_paving) ) %>%
  plot(add = TRUE,
       col = 'red',
       lwd =2)
```

Tactile paving seems mostly to be mapped (or maybe present in general) in central Leeds. It could be interesting to map the intersection between the kerb, tactile paving + sidewalks

-   I wonder to what extent is wheelchair and tactile information tagged together?? Both kerbs and tactile pavings are nodes in OSM data, but information related to tactile_paving is more extensively mapped (saying 'no' is also informative). I reckon, it's easier to evalute the presence of tactile paving than the height of kerb (which actually has no default values in OSM)...

### key:incline

Indicates a way's grade, slope or incline. In the case of roads, there is often a warning sign along the road. <https://wiki.openstreetmap.org/wiki/Key:incline>

```{r}
incline_perc <- perc_ratio(wy_walking, "incline") # see chunk 3 (or 'additional functions' section)
incline_perc

sf_col_table(wy_walking, "incline")  # see chunk 4 (or 'additional functions' section)

st_geometry(leeds) %>% plot(reset = FALSE)
wy_walking %>% select(incline) %>% 
  filter(!is.na(incline) & incline == "down" | incline == "up") %>%
  plot(add = TRUE,
       col = 'red',
       lwd = 2)

```

### key:est_width

Typically measured in meters. <https://wiki.openstreetmap.org/wiki/Key:width>

```{r}
estwidth_perc <- perc_ratio(wy_walking, "est_width") # see chunk 3 (or 'additional functions' section)
estwidth_perc 

sf_col_table(wy_walking, "est_width") # see chunk 4 (or 'additional functions' section)

st_geometry(leeds) %>% plot(reset = FALSE)
wy_walking %>% select(est_width) %>% 
  filter(!is.na(est_width)) %>%
  plot(add = TRUE,
       col = 'red',
       lwd = 2)
```

```{r}
# however, it's not clear for me if est_width is for roads, sidewalks, or cycleways? or all?
# I'll try to figure it out by finding out what highway values the rows that have est_width contain
est_width_df <- wy_walking %>% filter(!is.na(est_width))

wy_walking[est_width_df, op = st_within]

est_width_df %>% pull(highway) %>% table()
```

Cool, it seems to include all the ways but roads for motor traffic.

### tag sidewalk:left:width

```{r}
left_width_perc <- perc_ratio(wy_walking, "sidewalk_left_width") # see chunk 3 (or 'additional functions' section)
left_width_perc # no info
```

## key:width

The key width describes the actual width of a way or other feature. By default, values will be interpreted as metres. <https://wiki.openstreetmap.org/wiki/Key:width>

```{r}
width_perc <- perc_ratio(wy_walking, "width") # see chunk 3 (or 'additional functions' section)
width_perc 

sf_col_table(wy_walking, "width") # see chunk 4 (or 'additional functions' section)

st_geometry(leeds) %>% plot(reset = FALSE)
wy_walking %>% select(width) %>% 
  filter(!is.na(width)) %>%
  plot(add = TRUE,
       col = 'red',
       lwd = 2)

```

Width key suffers from the same issue as estimated width because it's not clear which ways have been measured and how many of them are footways.

```{r}
width_df <- wy_walking %>% filter(!is.na(width))
width_df %>% pull(highway) %>% table()
```

### ratios

```{r}
# table of ratios
ratios <- rbind(foot_perc,
      footway_perc,
      footway_coded_perc,
      sidewalk_perc,
      wheelchair_perc,
      kerb_perc,
      incline_perc,
      estwidth_perc,
      left_width_perc,
      tact_perc,
      width_perc)  %>% 
    as.data.frame() %>% arrange(desc(V1))

ratios
```



## linking pct data with Leeds Census 2011
```{r, message = FALSE}
# working with lsoa data
travel_foot_leeds_lsoa <- read_csv("~/Desktop/Method of travel to work On foot % 2011 lsoa.csv")
travel_foot_leeds_lsoa

# checking if leeds_pct$geo_code matches travel_foot_leeds_lsoa$NAME
leeds_pct$geo_code %in% travel_foot_leeds_lsoa$NAME %>% table() # TRUE 482

```

### pct + traveling on foot (%)
```{r}
# Cleaning data -- extracting digits from the `Method of travel to work: On foot %|2011` column

travel_foot_leeds_lsoa1 <- travel_foot_leeds_lsoa %>%
  mutate(foot_census = readr::parse_number(travel_foot_leeds_lsoa$"Method of travel to work: On foot %|2011")) # using `parse_number` to extract digits, which will be added to a new column called "value"

# there were 3 parsing failures. Let's check which ones failed
travel_foot_leeds_lsoa1 %>% filter(is.na(foot_census)) # not sure why they failed as I don't see any differences compared to other rows
# I'll fix this manually for now but I'll need to come up with more nuanced code to avoid parsing issues...
  
travel_foot_leeds_lsoa1$foot_census[travel_foot_leeds_lsoa1$NAME == "E01011375"] <- 7.2
travel_foot_leeds_lsoa1$foot_census[travel_foot_leeds_lsoa1$NAME == "E01011564"] <- 1.7
travel_foot_leeds_lsoa1$foot_census[travel_foot_leeds_lsoa1$NAME == "E01011670"] <- 12.7

# double-checking if there are any NAs left
travel_foot_leeds_lsoa1 %>% filter(is.na(value)) # none
```

### joining pct + census

```{r, message = FALSE}
# now we can join `leeds_pct` and `travel_foot_leeds_lsoa1` dataframes

leeds_joined_lsoa <- left_join(leeds_pct,
                          travel_foot_leeds_lsoa1,
                          by = c(geo_code = "NAME"))
# checking if we have `value` column
leeds_joined_lsoa %>% select(foot_census) # good :)
```

### plotting leeds_joined with osm
```{r}
leeds_joined_lsoa %>% select(foot_census) %>% plot

st_geometry(leeds_pct) %>% plot(reset = FALSE)
leeds_joined_lsoa %>% select(foot_census) %>% plot(add = TRUE)
wy_walking %>% filter(highway == "footway") %>% plot(add = TRUE,
                                                     col = "white")

# sf_col_table(leeds_joined_lsoa, "foot_census")

```

### pct + economically active (%)
Source: https://observatory.leeds.gov.uk/economy-and-employment/map/

What 'economically active' means?
Economically active ->	Employed ->	Includes part-time work
Economically active ->	Unemployed ->	Without a job - available and seeking work
Economically inactive ->	Economically inactive ->	Not seeking work - includes sick, retired, full-time students, looking after family

Question: 

- how is "Economically active: In employment" measured? If it says that '60%' does it refer to the total population of an area or to its sample (i.e., the one which is economically active)? 

```{r, message = FALSE}
# working with lsoa data
econ_active_leeds_lsoa <- read_csv("~/Desktop/Economically active % 2011 lsoa.csv")
econ_active_leeds_lsoa

# checking if leeds_pct$geo_code matches travel_foot_leeds_lsoa$NAME
leeds_pct$geo_code %in% travel_foot_leeds_lsoa$NAME %>% table() # TRUE 482

```

```{r}
# Cleaning data -- extracting digits from the `Economically active %|2011` column

econ_active_leeds_lsoa1 <- econ_active_leeds_lsoa %>%
  mutate(econ_active_census = readr::parse_number(econ_active_leeds_lsoa$"Economically active %|2011")) # using `parse_number` to extract digits, which will be added to a new column called "value"

# there were 3 parsing failures. Let's check which ones failed
econ_active_leeds_lsoa1 %>% filter(is.na(econ_active_census)) # It's interesting that the same rows failed to parse as in foot_census case. 
  
econ_active_leeds_lsoa1$econ_active_census[econ_active_leeds_lsoa1$NAME == "E01011375"] <- 63.7
econ_active_leeds_lsoa1$econ_active_census[econ_active_leeds_lsoa1$NAME == "E01011564"] <- 75.2
econ_active_leeds_lsoa1$econ_active_census[econ_active_leeds_lsoa1$NAME == "E01011670"] <- 50.6

# double-checking if there are any NAs left
econ_active_leeds_lsoa1 %>% filter(is.na(value)) # none
```

### joining leeds_joined + census on economically active %

```{r, message = FALSE}
# now we can join `leeds_joined` and `econ_active_leeds_lsoa1`

leeds_joined_lsoa <- left_join(leeds_joined_lsoa,
                          econ_active_leeds_lsoa1,
                          by = c(geo_code = "NAME"))

# saving data
# saveRDS(leeds_joined_lsoa,
#         "leeds_joined_lsoa.Rds")

# checking if we have `value` column
# leeds_joined_lsoa %>% select(econ_active_census) 

```

### plotting

```{r}
leeds_joined_lsoa %>% select(econ_active_census) %>% plot

st_geometry(leeds_pct) %>% plot(reset = FALSE)
leeds_joined_lsoa %>% select(econ_active_census) %>% plot(add = TRUE)
wy_walking %>% filter(highway == "footway") %>% plot(add = TRUE,
                                                     col = "white")
```


## Pedestrian infrastructure

Making a function that returns an OSM data frame with a new variable called 'pedestrian' that is 'yes/no/maybe'.

Next steps: adding a column regarding accessibility.

```{r}
# to make the computation faster, I'll drop the `geometry` column.
wy_walking_nogeom <- wy_walking %>% st_drop_geometry()
wy_walking_nogeom %>% ncol()
```

### recategorization: key:highway
```{r}
# I'll start recategorization from highway column.
sf_col_table(wy_walking_nogeom, "highway") # unique values in a decreasing order
# .
#        service    residential        footway          track           path   unclassified 
#          53446          44695          37086           7990           7352           6880 
#       tertiary        primary       cycleway          trunk          steps      secondary 
#           5202           3422           3325           2899           2705           1475 
#      bridleway     pedestrian       motorway  living_street  motorway_link   construction 
#           1268            808            577            395            393            339 
#     trunk_link   primary_link  tertiary_link       proposed       corridor secondary_link 
#            337            322            143             78             48             43 
#           road        raceway   bus_guideway         busway             no       services 
#             27             17             14              8              6              2 


highway_pedestrian_yes <- c("footway",
                                 "pedestrian",
                                 "living_street") # tags indicating pedestrian friendly highways

highway_pedestrian_maybe <- c("service",
                              "residential",
                              "track", # could also be yes but of poor quality?
                              "path", # could also be yes but of poor quality?
                              "unclassified",
                              "cycleway",
                              "steps", # friendly to pedestrians but not accessible?
                              "bridleway",
                              "corridor") # tags indicating *potentially* pedestrian friendly highways

highway_pedestrian_no <- c("tertiary",  
                           "primary",
                           "trunk",
                           "secondary",
                           "motorway",
                           "motorway_link",
                           "construction",
                           "trunk_link",
                           "primary_link",
                           "tertiary_link",
                           "proposed",
                           "secondary_link",
                           "road", # treated as a tagging error 
                           "raceway",
                           "bus_guideway",
                           "busway",
                           "no", # I think it's a tagging error
                           "services") 

wy_walking_nogeom1 <- wy_walking_nogeom %>% 
  mutate(pedestrian_friendly = case_when(
    # highway=*
    highway %in% highway_pedestrian_yes ~ "yes",
    highway %in% highway_pedestrian_maybe ~ "maybe",
    highway %in% highway_pedestrian_no ~ "no"
         )
         )

## just a quick sanity check that numbers match
wy_walking_nogeom1 %>% filter(pedestrian_friendly == "yes" | pedestrian_friendly == "maybe" | pedestrian_friendly == "no") %>% nrow() # 181302 rows that had been recoded
wy_walking_nogeom1 %>% filter(is.na(highway)) %>% nrow() # 53311 rows that have NAs in key:highway =*, hence no recoding
(181302 + 53311) == (wy_walking_nogeom %>% nrow()) # value must be TRUE

```


### recategorization: key:foot

```{r}
sf_col_table(wy_walking_nogeom, "foot")
# .
#         yes  designated  permissive          no     unknown     private   customers destination 
#        7479        3741         516         387         151         123          38          34 
# discouraged    delivery   emergency    informal     limited      permit 
#           3           1           1           1           1           1 

foot_pedestrian_yes <- c("yes",
                              "designated"
                              )

foot_pedestrian_maybe <- c("permissive",
                           "private",
                           "customers",
                           "destination", # or no?
                           "discouraged",
                           "delivery",
                           "permit"
                           )

foot_pedestrian_no <- c("no",
                        "unknown",
                        "emergency",
                        "informal", # not sure what it means
                        "limited" # not sure what it means
                        )

wy_walking_nogeom2 <- wy_walking_nogeom %>% 
  mutate(pedestrian_friendly = case_when(
    highway %in% highway_pedestrian_yes 
    ~ "yes",
    highway %in% highway_pedestrian_no 
    ~ "no",
    
    highway %in% highway_pedestrian_maybe & 
      foot %in% foot_pedestrian_yes  
    ~ "yes",
    
    highway %in% highway_pedestrian_maybe |
      foot %in% foot_pedestrian_maybe
    ~ "maybe",
    
    highway %in% highway_pedestrian_maybe & 
      foot %in% foot_pedestrian_no 
    ~ "no"
  )
  )


# checking if any "maybe" highways were reclassified to "yes" because foot was added
wy_walking_nogeom1 %>% filter(pedestrian_friendly == "yes") %>% nrow
wy_walking_nogeom2 %>% filter(pedestrian_friendly == "yes") %>% nrow
# pedestrian network expanded. Let's see how much
wy_walking_nogeom2 %>% filter(highway %in% highway_pedestrian_maybe, foot %in% foot_pedestrian_yes) %>% nrow() 
# 6080 rows
# Let's see how many of them are because cycleways are (potentially) shared
wy_walking_nogeom2 %>% filter(highway == "cycleway", foot %in% foot_pedestrian_yes) %>% nrow()
# 2030 rows
```

### recategorization: key:footway=*

```{r}
sf_col_table(wy_walking_nogeom, "footway")
# .
#       sidewalk       crossing   access_aisle           left             no traffic_island 
#           1546            512             77             11              9              6 
#            yes           none          alley           link             np 
#              5              3              1              1              1 

footway_pedestrian_yes <- c("sidewalk",
                            "crossing",
                            "access_aisle",
                            "left", # this is a depreciated way to indicate sidewalk on the left
                            "yes"
                            )

footway_pedestrian_maybe <- c("traffic_island", # is it the same as safety island???
                              "link",
                              "alley") 

footway_pedestrian_no <- c("no", # not sure what i
                           "none",
                           "np") # tagging error?


# wy_walking_nogeom2 <- wy_walking_nogeom1 %>% 
#   mutate(pedestrian = case_when(
#     # highway=*
#     highway %in% highway_pedestrian_yes ~ "yes",
#     highway %in% highway_pedestrian_maybe ~ "maybe",
#     highway %in% highway_pedestrian_no ~ "no",
#     # foot=*
#     highway %in% highway_pedestrian_maybe & foot %in% foot_pedestrian_yes ~ "yes", 
#     highway %in% highway_pedestrian_maybe & foot %in% foot_pedestrian_maybe ~ "maybe",
#     highway %in% highway_pedestrian_maybe & foot %in% foot_pedestrian_no ~ "no",
#     # footway=*
#     highway %in% highway_pedestrian_maybe & footway %in% footway_pedestrian_yes ~ "yes",
#     highway %in% highway_pedestrian_maybe & footway %in% footway_pedestrian_no ~ "no"
#          )
#          )

wy_walking_nogeom3 <- wy_walking_nogeom %>% 
  mutate(pedestrian_friendly = case_when(
    highway %in% highway_pedestrian_yes ~ "yes",
    highway %in% highway_pedestrian_no ~ "no",
    
    highway %in% highway_pedestrian_maybe & 
      foot %in% foot_pedestrian_yes | 
      footway %in% footway_pedestrian_yes 
    ~ "yes",
    
    highway %in% highway_pedestrian_maybe |
      foot %in% foot_pedestrian_maybe |
      footway %in% footway_pedestrian_maybe
    ~ "maybe",
    
    highway %in% highway_pedestrian_maybe & 
      foot %in% foot_pedestrian_no  | 
      footway %in% footway_pedestrian_no 
    ~ "no"
  )
  )

# tracking the recategorization changes 
# wy_walking_nogeom2 %>% filter(pedestrian_friendly == "yes") %>% nrow
# wy_walking_nogeom2 %>% filter(pedestrian_friendly == "maybe") %>% nrow 
# wy_walking_nogeom3 %>% filter(pedestrian_friendly == "yes") %>% nrow
# wy_walking_nogeom3 %>% filter(pedestrian_friendly == "maybe") %>% nrow
# wy_walking_nogeom2 %>% filter(pedestrian_friendly == "no") %>% nrow
# wy_walking_nogeom3 %>% filter(pedestrian_friendly == "no") %>% nrow
```

### recategorization: key:sidewalk=*
```{r}
sf_col_table(wy_walking_nogeom, "sidewalk")
# .
#       both         no       left      right       none   separate     mapped        yes   crossing 
#        833        452        432        201        163         79         23          6          1 
# left;right 
#          1 

sidewalk_pedestrian_yes <- c("both",
                             "left",
                             "right",
                             "separate",
                             "mapped", # I assume it indicates sidewalk's presence?
                             "yes",
                             "crossing", # most probably should have been assigned to footway=*
                             "left;right") 

sidewalk_pedestrian_no <- c("no",
                            "none")

wy_walking_nogeom4 <- wy_walking_nogeom %>% 
  mutate(pedestrian_friendly = case_when(
    highway %in% highway_pedestrian_yes ~ "yes",
    highway %in% highway_pedestrian_no ~ "no",
    
    highway %in% highway_pedestrian_maybe & 
      foot %in% foot_pedestrian_yes | 
      footway %in% footway_pedestrian_yes | 
      sidewalk %in% sidewalk_pedestrian_yes 
    ~ "yes",
    
    highway %in% highway_pedestrian_maybe |
      foot %in% foot_pedestrian_maybe |
      footway %in% footway_pedestrian_maybe # note, there's no "maybe" sidewalk
    ~ "maybe",
    
    highway %in% highway_pedestrian_maybe & 
      foot %in% foot_pedestrian_no  | 
      footway %in% footway_pedestrian_no | 
      sidewalk %in% sidewalk_pedestrian_no 
    ~ "no"
         )
         )

# wy_walking_nogeom4 %>% filter(pedestrian_friendly == "yes") %>% nrow()
#> 45169 
# wy_walking_nogeom4 %>% filter(pedestrian_friendly == "maybe") %>% nrow()
#> 120834
```

### recategorization: key:pedestrian=*

```{r}
sf_col_table(wy_walking,"pedestrian")
# crossing 
#        2

ped_pedestrian_yes <- c("crossing ")

wy_walking_nogeom5 <- wy_walking_nogeom %>% 
  mutate(pedestrian_friendly = case_when(
    highway %in% highway_pedestrian_yes ~ "yes",
    highway %in% highway_pedestrian_no ~ "no",
    
    highway %in% highway_pedestrian_maybe & 
      foot %in% foot_pedestrian_yes | 
      footway %in% footway_pedestrian_yes | 
      sidewalk %in% sidewalk_pedestrian_yes |
      pedestrian %in% ped_pedestrian_yes
    ~ "yes",
    
    highway %in% highway_pedestrian_maybe |
      foot %in% foot_pedestrian_maybe |
      footway %in% footway_pedestrian_maybe # note: there's no "maybe" sidewalk
    ~ "maybe",
    
    highway %in% highway_pedestrian_maybe & 
      foot %in% foot_pedestrian_no  | 
      footway %in% footway_pedestrian_no | 
      sidewalk %in% sidewalk_pedestrian_no 
    ~ "no"
         )
         )


```

### recategorization: key:path=*

```{r}
sf_col_table(wy_walking,"path")
# .
# footpath       no 
#        1        1 

path_pedestrian_yes <- c("footpath")

path_pedestrian_no <- c("no")

wy_walking_nogeom6 <- wy_walking_nogeom %>% 
  mutate(pedestrian_friendly = case_when(
    highway %in% highway_pedestrian_yes ~ "yes",
    highway %in% highway_pedestrian_no ~ "no",
    
    highway %in% highway_pedestrian_maybe & 
      foot %in% foot_pedestrian_yes | 
      footway %in% footway_pedestrian_yes | 
      sidewalk %in% sidewalk_pedestrian_yes |
      pedestrian %in% ped_pedestrian_yes |
      path %in% path_pedestrian_yes
    ~ "yes",
    
    highway %in% highway_pedestrian_maybe |
      foot %in% foot_pedestrian_maybe |
      footway %in% footway_pedestrian_maybe # note: there's no "maybe" sidewalk
    ~ "maybe",
    
    highway %in% highway_pedestrian_maybe & 
      foot %in% foot_pedestrian_no  | 
      footway %in% footway_pedestrian_no | 
      sidewalk %in% sidewalk_pedestrian_no |
      path %in% path_pedestrian_no
    ~ "no"
         )
         )

# let's see how how many "maybe" highways were recategorized to pedestrian_friendly = "yes" or "no"
(wy_walking_nogeom6 %>% filter(pedestrian_friendly == "yes") %>% nrow()) - (wy_walking_nogeom1 %>% filter(pedestrian_friendly == "yes") %>% nrow())
#> 6880
(wy_walking_nogeom6 %>% filter(pedestrian_friendly == "maybe") %>% nrow()) - (wy_walking_nogeom1 %>% filter(pedestrian_friendly == "maybe") %>% nrow())
#> -6875
```


